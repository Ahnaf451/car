<!DOCTYPE html>
<html>
<head>
    <title>Porsche 911 GT2 - Realismo HDR</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #ui { position: absolute; top: 30px; left: 30px; color: #fff; font-family: 'Segoe UI', sans-serif; pointer-events: none; }
        .kmh { font-size: 50px; font-weight: 800; color: #00ffff; text-shadow: 0 0 20px #00ffff; }
    </style>
</head>
<body>
    <div id="ui">
        <div id="speed" class="kmh">0</div>
        <div style="font-size: 14px; opacity: 0.6;">KM/H</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

        const scene = new THREE.Scene();
        
        // --- 1. AMBIENTE E RIFLESSI (Il segreto del realismo) ---
        // Creiamo un "generatore di riflessi" per la vernice
        const pmremGenerator = new THREE.PMREMGenerator(new THREE.WebGLRenderer());
        scene.environment = pmremGenerator.fromScene(new THREE.Scene()).texture;

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ACESFilmicToneMapping; // Tone mapping cinematografico
        renderer.toneMappingExposure = 1.2;
        document.body.appendChild(renderer.domElement);

        // --- 2. MATERIALE PORSCHE AVANZATO ---
        let car = new THREE.Group();
        const loader = new OBJLoader();
        
        loader.load('Porsche_911_GT2.obj', (obj) => {
            const box = new THREE.Box3().setFromObject(obj);
            const size = box.getSize(new THREE.Vector3());
            obj.position.y = size.y / 2; // Perfettamente a terra

            obj.traverse(c => {
                if (c.isMesh) {
                    // Vernice metallizzata realistica
                    c.material = new THREE.MeshPhysicalMaterial({ 
                        color: 0x003366,       // Blu profondo (molto più realistico dell'azzurro neon)
                        metalness: 1.0,        // Puro metallo
                        roughness: 0.1,        // Superficie liscia
                        clearcoat: 1.0,        // Strato di "lucido" sopra la vernice
                        clearcoatRoughness: 0.05,
                        reflectivity: 1.0
                    });
                }
            });
            car.add(obj);
            car.scale.set(1.5, 1.5, 1.5);
            scene.add(car);
        });

        // --- 3. FISICA "SMOOTH" ---
        let speed = 0, targetSpeed = 0, steer = 0;
        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        // Strada con asfalto scuro e strisce neon
        const roadGeo = new THREE.PlaneGeometry(30, 1000);
        const roadMat = new THREE.MeshStandardMaterial({ color: 0x050505, roughness: 0.8 });
        const road = new THREE.Mesh(roadGeo, roadMat);
        road.rotation.x = -Math.PI / 2;
        scene.add(road);

        // Luci della città (punti luce che scorrono per creare riflessi sulla carrozzeria)
        const lights = [];
        for(let i=0; i<10; i++) {
            const light = new THREE.PointLight(Math.random() > 0.5 ? 0x00ffff : 0xff00ff, 10, 50);
            light.position.set(i % 2 ? -15 : 15, 5, -i * 50);
            scene.add(light);
            lights.push(light);
        }

        function animate() {
            requestAnimationFrame(animate);

            // Accelerazione realistica
            if (keys['KeyW']) targetSpeed = Math.min(targetSpeed + 0.005, 1.0);
            else targetSpeed *= 0.99;
            
            speed = THREE.MathUtils.lerp(speed, targetSpeed, 0.05);
            
            // Sterzo fluido
            const steerInput = (keys['KeyA'] ? 0.04 : 0) - (keys['KeyD'] ? 0.04 : 0);
            steer = THREE.MathUtils.lerp(steer, steerInput * speed, 0.1);
            car.position.x += steer * 15;
            car.rotation.y = steer * 10;
            car.rotation.z = -steer * 5; // L'auto si imbarca dolcemente

            // Scorrimento luci e strada per simulare il movimento
            lights.forEach(l => {
                l.position.z += speed * 50;
                if(l.position.z > 20) l.position.z = -480;
            });
            road.position.z = (road.position.z + speed * 50) % 100;

            // Update UI
            document.getElementById('speed').innerText = Math.floor(speed * 240);

            // Camera dinamica
            camera.position.lerp(new THREE.Vector3(car.position.x * 0.5, 3.5, 10), 0.05);
            camera.lookAt(car.position.x, 1, -20);

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
